<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Controle Financeiro - Dayerre</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/date-eu.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Google APIs (com onload) -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 0;
      min-height: 100vh;
      font-size: 14px;
    }
    .navbar {
      background: linear-gradient(135deg, #007AFF, #005bb5);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 24px;
      border: none;
    }
    .summary-card {
      text-align: center;
      padding: 20px;
      border-radius: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .summary-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
    .summary-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .summary-value { font-size: 2rem; font-weight: 700; }

    tfoot input { width: 100%; padding: 6px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; }
    .edit-cell { cursor: pointer; padding: 6px !important; font-size: 13px; }
    .edit-cell:hover { background: #f0f8ff !important; }
    #addRowForm { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 16px; display: none; }

    table.dataTable td { padding: 6px !important; font-size: 13px; }
    table.dataTable th { padding: 8px !important; font-size: 13px; text-align: center; }
    .dataTables_scrollBody { overflow-x: auto !important; }

    .money-cell { text-align: right; white-space: nowrap; font-weight: 500; }

    #monthlyReportModal .modal-dialog { max-width: 95%; }
    #monthlyReportTable td, #monthlyReportTable th { padding: 6px !important; font-size: 13px; }
    .month-input { width: 180px; }

    /* Melhor para celular: botões quebram linha bonito */
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
    .toolbar .btn { margin: 0 !important; }
    .status-pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; }
  </style>
</head>

<body>
  <div class="navbar">Controle Financeiro - Dayerre</div>

  <div class="container pt-4">
    <div class="card">
      <h3 class="mb-4 text-center">Resumo Financeiro</h3>
      <div class="row text-center">
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-wallet2 summary-icon text-primary"></i>
            <div>Total Geral</div>
            <div class="summary-value text-primary" id="totalGeral">R$ 0,00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-check-circle summary-icon text-success"></i>
            <div>Total Pago</div>
            <div class="summary-value text-success" id="totalPago">R$ 0,00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-exclamation-triangle summary-icon text-danger"></i>
            <div>Total a Pagar</div>
            <div class="summary-value text-danger" id="totalAPagar">R$ 0,00</div>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-center mt-2" style="gap:10px;">
        <div>
          <span id="sheetsStatus" class="status-pill bg-light text-secondary">Sheets: aguardando…</span>
        </div>
        <div>
          <label class="mb-0" style="user-select:none;">
            <input type="checkbox" id="chkAutoSave" />
            Salvar automático no Sheets
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Lançamentos (Mais recente primeiro)</h3>

      <div class="toolbar">
        <button id="btnImportCSV" class="btn btn-info">Importar CSV</button>
        <button id="btnExportCSV" class="btn btn-outline-primary">Exportar CSV</button>

        <button id="btnAddRow" class="btn btn-primary">+ Nova Parcela</button>
        <button id="btnExcluirRegistro" class="btn btn-danger">Excluir Registros</button>
        <button id="btnMarcarPago" class="btn btn-success">Marcar como Pago</button>
        <button id="btnUpdateTotals" class="btn btn-secondary">Atualizar Totais</button>
        <button id="btnMonthlyReport" class="btn btn-info">Relatórios Mensais</button>

        <button id="btnLoadSheets" class="btn btn-warning" disabled>Carregar do Sheets</button>
        <button id="btnSaveSheets" class="btn btn-warning" disabled>Salvar no Sheets</button>

        <input type="file" id="fileInput" accept=".csv" style="display:none;" />
      </div>

      <div id="addRowForm" style="display:none;">
        <div class="card bg-light mb-4">
          <div class="card-body">
            <h5 class="card-title">Adicionar Nova Parcela</h5>
            <form id="newRowForm">
              <div class="form-row">
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newDataCompra" placeholder="DD/MM/AAAA" required />
                </div>
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newReceber" list="receberOptions" placeholder="Quem recebe" required />
                  <datalist id="receberOptions"></datalist>
                </div>
                <div class="col-md-4 mb-2">
                  <input type="text" class="form-control" id="newDescricao" placeholder="Descrição" required />
                </div>
                <div class="col-md-2 mb-2">
                  <input type="text" class="form-control" id="newLoja" list="lojaOptions" placeholder="Loja" />
                  <datalist id="lojaOptions"></datalist>
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newValorTotal" placeholder="R$ Valor Total" required />
                </div>
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newCartao" list="cartaoOptions" placeholder="Cartão" required />
                  <datalist id="cartaoOptions"></datalist>
                </div>
                <div class="col-md-2 mb-2">
                  <input type="number" class="form-control" id="newTotalParcelas" min="1" value="1" placeholder="Total Parc." required />
                </div>
                <div class="col-md-2 mb-2">
                  <input type="text" class="form-control" id="newValorParcela" placeholder="R$ Parcela" readonly />
                </div>
                <div class="col-md-4 mb-2">
                  <input type="text" class="form-control" id="newDataPagamento" placeholder="DD/MM/AAAA" required />
                </div>
                <div class="col-md-3 mb-2">
                  <select class="form-control" id="newStatus" required>
                    <option value="Pago">Pago</option>
                    <option value="Em aberto" selected>Em aberto</option>
                  </select>
                </div>
                <div class="col-md-2 mb-2">
                  <button type="submit" class="btn btn-success btn-block">Adicionar</button>
                </div>
                <div class="col-md-2 mb-2">
                  <button type="button" id="cancelAdd" class="btn btn-secondary btn-block">Cancelar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <table id="dataTable" class="display compact" style="width:100%;">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>DATA COMPRA</th>
            <th>VALORES A RECEBER</th>
            <th>DESCRIÇÃO</th>
            <th>LOJA</th>
            <th>VALOR TOTAL</th>
            <th>CARTÃO</th>
            <th>TOTAL PARCELAS</th>
            <th>PARCELA</th>
            <th>VALOR PARCELA</th>
            <th>DATA PAGTO</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th></th>
            <th>Filtro</th><th>Filtro</th><th>Filtro</th><th>Filtro</th><th>Filtro</th>
            <th>Filtro</th><th>Filtro</th><th>Filtro</th><th>Filtro</th><th>Filtro</th><th>Filtro</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Modal Relatórios Mensais -->
  <div class="modal fade" id="monthlyReportModal" tabindex="-1" role="dialog" aria-labelledby="monthlyReportLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="monthlyReportLabel">Relatórios Mensais Financeiros</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true"></span>
          </button>
        </div>

        <div class="modal-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="monthInput">Mês/Ano</label>
              <input type="month" id="monthInput" class="form-control month-input" />
            </div>
            <div class="col-md-4 mb-3">
              <label for="recipientSelect">Quem Recebe</label>
              <select id="recipientSelect" class="form-control">
                <option value="Todos">Todos</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="cardSelect">Cartão</label>
              <select id="cardSelect" class="form-control">
                <option value="Todos">Todos</option>
              </select>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-body">
              <h5>Resumo do Período Filtrado</h5>
              <div class="row text-center">
                <div class="col-md-4">Total Geral <strong id="reportTotalGeral">R$ 0,00</strong></div>
                <div class="col-md-4">Total Pago <strong id="reportTotalPago">R$ 0,00</strong></div>
                <div class="col-md-4">Total a Pagar <strong id="reportTotalAPagar">R$ 0,00</strong></div>
              </div>
            </div>
          </div>

          <table id="monthlyReportTable" class="display compact mt-4" style="width:100%;">
            <thead>
              <tr>
                <th>DATA COMPRA</th>
                <th>VALORES A RECEBER</th>
                <th>DESCRIÇÃO</th>
                <th>LOJA</th>
                <th>VALOR TOTAL</th>
                <th>CARTÃO</th>
                <th>PARCELA TOTAL</th>
                <th>VALOR PARCELA</th>
                <th>DATA PAGTO</th>
                <th>STATUS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  /**********************
   * CONFIGURAÇÕES SHEETS
   **********************/
  const CLIENT_ID = "749047478128-8mh27i6lmrbljkn0b7i2u9p8q28i8t63.apps.googleusercontent.com";
  const SPREADSHEET_ID = "1CMaWjOpN45pjtMYAs9hfn0ovFvhXPaiZNbwDnzNSuZA";
  const SHEET_NAME = "Sheet1"; // ajuste se sua aba for "Folha1"
  const DISCOVERY_DOC = "https://sheets.googleapis.com/$discovery/rest?version=v4";

  const HEADERS = ["DATA COMPRA","VALORES A RECEBER","DESCRIÇÃO","LOJA","VALOR TOTAL","CARTÃO","TOTAL PARCELAS","PARCELA","VALOR PARCELA","DATA PAGTO","STATUS"];
  const DATA_RANGE_A1 = `${SHEET_NAME}!A:K`;   // leitura
  const WRITE_START_A1 = `${SHEET_NAME}!A1`;  // escrita (salvar tudo)

  let tokenClient = null;
  let gapiInited = false;
  let gisInited = false;
  let hasToken = false;

  /**********************
   * DADOS / TABELAS
   **********************/
  let tableData = [];
  let dataTable = null;
  let monthlyReportTable = null;

  /**********************
   * Helpers (money/date)
   **********************/
  function formatMoneyBR(num) {
    if (isNaN(num) || num === null) return "R$ 0,00";
    return "R$ " + Number(num).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // Aceita: "12,34", "1.234,56", "R$ 1.234,56", "1234.56", "R$1234,56"
  function parseMoneyBR(str) {
    if (str === null || str === undefined) return 0;
    const cleaned = String(str).replace(/\s/g, "").replace(/^R\$/i, "").replace(/[^0-9,.\-]/g, "");
    if (!cleaned) return 0;
    if (cleaned.includes(",")) return parseFloat(cleaned.replace(/\./g, "").replace(",", ".")) || 0;
    return parseFloat(cleaned) || 0;
  }

  function parseDateBR(s) {
    if (!s) return null;
    const [d, m, y] = String(s).split("/");
    return (y && m && d) ? new Date(y, m - 1, d) : null;
  }

  function formatDateBR(date) {
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    return `${d}/${m}/${date.getFullYear()}`;
  }

  function addMonthsToDateBR(s, months) {
    const d = parseDateBR(s);
    if (!d) return s;
    d.setMonth(d.getMonth() + months);
    return formatDateBR(d);
  }

  function setSheetsStatus(text, kind) {
    const el = document.getElementById("sheetsStatus");
    el.textContent = text;
    el.classList.remove("bg-light","bg-success","bg-warning","bg-danger","text-secondary","text-dark","text-white");
    if (kind === "ok") el.classList.add("bg-success","text-white");
    else if (kind === "warn") el.classList.add("bg-warning","text-dark");
    else if (kind === "err") el.classList.add("bg-danger","text-white");
    else el.classList.add("bg-light","text-secondary");
  }

  function normalizeRow(r) {
    return {
      "DATA COMPRA": (r["DATA COMPRA"] || "").trim(),
      "VALORES A RECEBER": (r["VALORES A RECEBER"] || "").trim(),
      "DESCRIÇÃO": (r["DESCRIÇÃO"] || "").trim(),
      "LOJA": (r["LOJA"] || "").trim(),
      "VALOR TOTAL": formatMoneyBR(parseMoneyBR(r["VALOR TOTAL"] || "0")),
      "CARTÃO": (r["CARTÃO"] || "").trim(),
      "TOTAL PARCELAS": parseInt(r["TOTAL PARCELAS"]) || 1,
      "PARCELA": parseInt(r["PARCELA"]) || 1,
      "VALOR PARCELA": formatMoneyBR(parseMoneyBR(r["VALOR PARCELA"] || "0")),
      "DATA PAGTO": (r["DATA PAGTO"] || "").trim(),
      "STATUS": (r["STATUS"] || "Em aberto").trim() || "Em aberto"
    };
  }

  /**********************
   * UI updates
   **********************/
  function updateAutoCompleteOptions() {
    const receberSet = new Set(tableData.map(r => r["VALORES A RECEBER"]).filter(Boolean));
    const cartaoSet  = new Set(tableData.map(r => r["CARTÃO"]).filter(Boolean));
    const lojaSet    = new Set(tableData.map(r => r["LOJA"]).filter(Boolean));

    $("#receberOptions").html(Array.from(receberSet).sort().map(v => `<option value="${v}"></option>`).join(""));
    $("#cartaoOptions").html(Array.from(cartaoSet).sort().map(v => `<option value="${v}"></option>`).join(""));
    $("#lojaOptions").html(Array.from(lojaSet).sort().map(v => `<option value="${v}"></option>`).join(""));
  }

  function updateDashboard() {
    let totalG = 0, pago = 0, apagar = 0;
    tableData.forEach(r => {
      const v = parseMoneyBR(r["VALOR PARCELA"]);
      totalG += v;
      if (r["STATUS"] === "Pago") pago += v;
      else apagar += v;
    });
    $("#totalGeral").text(formatMoneyBR(totalG));
    $("#totalPago").text(formatMoneyBR(pago));
    $("#totalAPagar").text(formatMoneyBR(apagar));
  }

  function initTable() {
    if (dataTable) dataTable.destroy();

    dataTable = $("#dataTable").DataTable({
      data: tableData,
      columns: [
        { data: null, orderable: false, render: () => '<input type="checkbox" class="row-checkbox" />' },
        { data: "DATA COMPRA", type: "date-eu", className: "edit-cell" },
        { data: "VALORES A RECEBER", className: "edit-cell" },
        { data: "DESCRIÇÃO", className: "edit-cell" },
        { data: "LOJA", className: "edit-cell" },
        { data: "VALOR TOTAL", render: d => formatMoneyBR(parseMoneyBR(d)), className: "edit-cell money-cell" },
        { data: "CARTÃO", className: "edit-cell" },
        { data: "TOTAL PARCELAS", className: "edit-cell text-center" },
        { data: "PARCELA", className: "edit-cell text-center" },
        { data: "VALOR PARCELA", render: d => formatMoneyBR(parseMoneyBR(d)), className: "edit-cell money-cell" },
        { data: "DATA PAGTO", className: "edit-cell" },
        { data: "STATUS", className: "edit-cell" }
      ],
      order: [[1, "desc"]],
      pageLength: 20,
      lengthMenu: [20, 40, 60, 80, 100, 200, -1],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
      scrollX: true,
      initComplete: function () {
        this.api().columns().every(function (i) {
          if (i === 0) return;
          const column = this;
          $('<input type="text" class="form-control form-control-sm" placeholder="Filtrar...">')
            .appendTo($(column.footer()).empty())
            .on("keyup change", function () {
              if (column.search() !== this.value) column.search(this.value).draw();
            });
        });
      }
    });

    $("#dataTable tbody").off("click").on("click", "td.edit-cell", function () {
      const cell = dataTable.cell(this);
      const field = dataTable.column(cell.index().column).header().textContent.trim();
      const oldVal = cell.data();

      const input = $(`<input type="text" class="form-control form-control-sm" value="${oldVal ?? ""}">`);
      $(this).html(input);
      input.focus().select();

      input.on("blur", async function () {
        let newVal = input.val().trim();

        if (field.includes("VALOR")) {
          newVal = formatMoneyBR(parseMoneyBR(newVal));
        } else if (field.includes("TOTAL PARCELAS") || field === "PARCELA") {
          newVal = parseInt(newVal) || 0;
        }

        cell.data(newVal);
        dataTable.draw(false);

        // mantém o array tableData consistente com a linha editada
        const rowIdx = cell.index().row;
        tableData[rowIdx][field] = newVal;
        tableData[rowIdx] = normalizeRow(tableData[rowIdx]);

        updateDashboard();
        updateAutoCompleteOptions();

        if ($("#chkAutoSave").prop("checked")) {
          await saveAllToSheets();
        }
      });

      input.on("keypress", function (e) { if (e.which === 13) input.blur(); });
    });

    $("#selectAll").off("change").on("change", function () {
      $(".row-checkbox").prop("checked", this.checked);
    });
  }

  /**********************
   * CSV import/export
   **********************/
  $("#btnImportCSV").on("click", () => $("#fileInput").click());

  $("#fileInput").on("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      delimiter: ",",
      transformHeader: h => h.trim().toUpperCase().replace(/\s+/g, " "),
      complete: async function (results) {
        if (results.errors && results.errors.length > 0) {
          alert("Erro ao ler o CSV: " + results.errors.map(e => e.message).join(", "));
          return;
        }

        tableData = (results.data || []).map(row => normalizeRow({
          "DATA COMPRA": row["DATA COMPRA"] || "",
          "VALORES A RECEBER": row["VALORES A RECEBER"] || "",
          "DESCRIÇÃO": row["DESCRIÇÃO"] || "",
          "LOJA": row["LOJA"] || "",
          "VALOR TOTAL": row["VALOR TOTAL"] || "0",
          "CARTÃO": row["CARTÃO UTILIZADO"] || row["CARTAO"] || row["CARTÃO"] || "",
          "TOTAL PARCELAS": row["TOTAL PARCELAS"] || row["TOTAL PARC."] || 1,
          "PARCELA": row["PARCELA ATUAL"] || row["PARCELA"] || 1,
          "VALOR PARCELA": row["VALOR PARCELA"] || "0",
          "DATA PAGTO": row["DATA PAGAMENTO"] || row["DATA PAGTO"] || "",
          "STATUS": row["STATUS"] || "Em aberto"
        })).filter(r => r["DATA COMPRA"] || r["DESCRIÇÃO"] || parseMoneyBR(r["VALOR PARCELA"]) > 0);

        initTable();
        updateDashboard();
        updateAutoCompleteOptions();

        if ($("#chkAutoSave").prop("checked")) {
          await saveAllToSheets();
        } else {
          alert("Importado. Clique em “Salvar no Sheets” para gravar.");
        }
      }
    });

    this.value = "";
  });

  $("#btnExportCSV").on("click", function () {
    if (tableData.length === 0) { alert("Não há dados para exportar."); return; }
    const csv = Papa.unparse(tableData);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `controlefinanceiro-dayerre-${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  /**********************
   * Add parcelas
   **********************/
  $("#btnAddRow").on("click", function () {
    $("#addRowForm").slideToggle(300);
    updateAutoCompleteOptions();
    const hoje = formatDateBR(new Date());
    $("#newDataCompra").val(hoje);
    $("#newDataPagamento").val(hoje);
  });

  $("#cancelAdd").on("click", function () {
    $("#addRowForm").slideUp(300);
    $("#newRowForm")[0].reset();
  });

  $("#newDataCompra, #newDataPagamento").on("input", function () {
    let v = this.value.replace(/\D/g, "").slice(0, 8);
    if (v.length > 2) v = v.slice(0,2) + "/" + v.slice(2);
    if (v.length > 5) v = v.slice(0,5) + "/" + v.slice(5);
    this.value = v;
  });

  $("#newValorTotal").on("input", function () {
    this.value = this.value.replace(/[^0-9,.\-]/g, "");
  });

  $("#newValorTotal, #newTotalParcelas").on("input change", function () {
    const total = parseMoneyBR($("#newValorTotal").val());
    const parc = parseInt($("#newTotalParcelas").val()) || 1;
    $("#newValorParcela").val(formatMoneyBR(total / parc));
  });

  $("#newRowForm").on("submit", async function (e) {
    e.preventDefault();

    const dataCompra = $("#newDataCompra").val().trim();
    const dataPrimeira = $("#newDataPagamento").val().trim();

    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dataCompra)) { alert("Data da compra inválida! Use DD/MM/AAAA"); return; }
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dataPrimeira)) { alert("Data da primeira parcela inválida! Use DD/MM/AAAA"); return; }

    const base = normalizeRow({
      "DATA COMPRA": dataCompra,
      "VALORES A RECEBER": $("#newReceber").val().trim(),
      "DESCRIÇÃO": $("#newDescricao").val().trim(),
      "LOJA": $("#newLoja").val().trim(),
      "VALOR TOTAL": $("#newValorTotal").val(),
      "CARTÃO": $("#newCartao").val().trim(),
      "TOTAL PARCELAS": parseInt($("#newTotalParcelas").val()) || 1,
      "PARCELA": 1,
      "VALOR PARCELA": $("#newValorParcela").val(),
      "DATA PAGTO": dataPrimeira,
      "STATUS": $("#newStatus").val()
    });

    const totalParcelas = base["TOTAL PARCELAS"];
    for (let i = 1; i <= totalParcelas; i++) {
      const r = { ...base, "PARCELA": i, "DATA PAGTO": addMonthsToDateBR(dataPrimeira, i - 1) };
      tableData.push(normalizeRow(r));
    }

    tableData.sort((a, b) => (parseDateBR(b["DATA COMPRA"]) - parseDateBR(a["DATA COMPRA"])));

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    this.reset();
    $("#addRowForm").slideUp(300);

    if ($("#chkAutoSave").prop("checked")) {
      await saveAllToSheets();
    } else {
      alert("Parcelas adicionadas. Clique em “Salvar no Sheets” para gravar.");
    }
  });

  /**********************
   * Excluir / Marcar Pago
   **********************/
  $("#btnExcluirRegistro").on("click", async function () {
    const selecionados = $(".row-checkbox:checked").length;
    if (selecionados === 0) { alert("Selecione pelo menos um registro para excluir."); return; }
    if (!confirm(`Tem certeza que deseja excluir ${selecionados} registros?`)) return;

    const indices = [];
    $(".row-checkbox:checked").each(function () {
      const row = $(this).closest("tr");
      const idx = dataTable.row(row).index();
      indices.push(idx);
    });

    indices.sort((a,b) => b-a).forEach(idx => tableData.splice(idx, 1));

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
  });

  $("#btnMarcarPago").on("click", async function () {
    const selecionados = $(".row-checkbox:checked").length;
    if (selecionados === 0) { alert("Selecione pelo menos um registro para marcar como pago."); return; }
    if (!confirm(`Tem certeza que deseja marcar ${selecionados} registros como PAGO?`)) return;

    $(".row-checkbox:checked").each(function () {
      const row = $(this).closest("tr");
      const idx = dataTable.row(row).index();
      if (tableData[idx]) tableData[idx]["STATUS"] = "Pago";
      tableData[idx] = normalizeRow(tableData[idx]);
    });

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
  });

  $("#btnUpdateTotals").on("click", function () {
    initTable();
    updateDashboard();
    updateAutoCompleteOptions();
    alert("Totais atualizados com sucesso!");
  });

  /**********************
   * Relatórios Mensais
   **********************/
  function updateReport() {
    const monthValue = $("#monthInput").val();
    const recipient = $("#recipientSelect").val();
    const card = $("#cardSelect").val();

    const filtered = tableData.filter(row => {
      const datePagto = parseDateBR(row["DATA PAGTO"]);
      if (!datePagto) return false;

      if (monthValue) {
        const [y, m] = monthValue.split("-").map(Number);
        if (datePagto.getFullYear() !== y) return false;
        if ((datePagto.getMonth() + 1) !== m) return false;
      }
      if (recipient && recipient !== "Todos" && row["VALORES A RECEBER"] !== recipient) return false;
      if (card && card !== "Todos" && row["CARTÃO"] !== card) return false;

      return true;
    });

    let total = 0, pago = 0, apagar = 0;
    filtered.forEach(r => {
      const v = parseMoneyBR(r["VALOR PARCELA"]);
      total += v;
      if (r["STATUS"] === "Pago") pago += v;
      else apagar += v;
    });

    $("#reportTotalGeral").text(formatMoneyBR(total));
    $("#reportTotalPago").text(formatMoneyBR(pago));
    $("#reportTotalAPagar").text(formatMoneyBR(apagar));

    if (monthlyReportTable) monthlyReportTable.destroy();

    monthlyReportTable = $("#monthlyReportTable").DataTable({
      data: filtered,
      columns: [
        { data: "DATA COMPRA" },
        { data: "VALORES A RECEBER" },
        { data: "DESCRIÇÃO" },
        { data: "LOJA" },
        { data: "VALOR TOTAL", render: d => formatMoneyBR(parseMoneyBR(d)) },
        { data: "CARTÃO" },
        { data: null, render: d => `${d["PARCELA"]}/${d["TOTAL PARCELAS"]}`, className: "text-center" },
        { data: "VALOR PARCELA", render: d => formatMoneyBR(parseMoneyBR(d)) },
        { data: "DATA PAGTO" },
        { data: "STATUS" }
      ],
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100, -1],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
      dom: "frtip",
      order: [[8, "asc"]]
    });
  }

  $("#btnMonthlyReport").on("click", function () {
    const recipientSet = new Set(tableData.map(r => r["VALORES A RECEBER"]).filter(Boolean));
    const cardSet = new Set(tableData.map(r => r["CARTÃO"]).filter(Boolean));

    const selRec = $("#recipientSelect");
    selRec.empty().append(`<option value="Todos">Todos</option>`);
    Array.from(recipientSet).sort().forEach(v => selRec.append(`<option value="${v}">${v}</option>`));

    const selCard = $("#cardSelect");
    selCard.empty().append(`<option value="Todos">Todos</option>`);
    Array.from(cardSet).sort().forEach(v => selCard.append(`<option value="${v}">${v}</option>`));

    if (monthlyReportTable) monthlyReportTable.destroy();
    updateReport();
    $("#monthlyReportModal").modal("show");
  });

  $("#monthInput, #recipientSelect, #cardSelect").on("change", updateReport);

  /**********************
   * GOOGLE init (robusto)
   **********************/
  function maybeEnableSheetsButtons() {
    if (gapiInited && gisInited) {
      document.getElementById("btnLoadSheets").disabled = false;
      document.getElementById("btnSaveSheets").disabled = false;
      setSheetsStatus("Sheets: pronto (faça login para carregar/salvar)", "warn");
    }
  }

  window.gapiLoaded = function () {
    gapi.load("client", async () => {
      try {
        await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
        maybeEnableSheetsButtons();
      } catch (e) {
        console.error("Falha ao inicializar gapi.client:", e);
        setSheetsStatus("Sheets: erro ao iniciar gapi", "err");
        alert("Falha ao inicializar Google API (gapi). Veja o console (F12).");
      }
    });
  };

  window.gisLoaded = function () {
    try {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets",
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.error) {
            console.error("Erro OAuth:", tokenResponse);
            setSheetsStatus("Sheets: erro no login", "err");
            alert("Erro na autorização: " + tokenResponse.error);
            return;
          }
          hasToken = true;
          setSheetsStatus("Sheets: autenticado", "ok");
          // Após login, a ação (carregar/salvar) é chamada por quem pediu
        }
      });
      gisInited = true;
      maybeEnableSheetsButtons();
    } catch (e) {
      console.error("Falha ao inicializar GIS tokenClient:", e);
      setSheetsStatus("Sheets: erro ao iniciar login", "err");
      alert("Falha ao inicializar Google Identity Services. Veja o console (F12).");
    }
  };

  async function ensureAccessToken() {
    if (hasToken) return true;
    if (!tokenClient) return false;

    return new Promise((resolve) => {
      tokenClient.callback = (tokenResponse) => {
        if (tokenResponse && tokenResponse.error) {
          console.error("Erro OAuth:", tokenResponse);
          setSheetsStatus("Sheets: erro no login", "err");
          resolve(false);
          return;
        }
        hasToken = true;
        setSheetsStatus("Sheets: autenticado", "ok");
        resolve(true);
      };
      tokenClient.requestAccessToken({ prompt: "" }); // tenta silencioso; se precisar, o Google abre consent
    });
  }

  /**********************
   * Ler/Salvar no Sheets
   **********************/
  async function loadFromSheets() {
    const ok = await ensureAccessToken();
    if (!ok) { alert("Não foi possível autenticar no Google."); return; }

    try {
      setSheetsStatus("Sheets: carregando…", "warn");

      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: DATA_RANGE_A1
      });

      const rows = response.result.values || [];

      if (rows.length <= 1) {
        tableData = [];
      } else {
        tableData = rows.slice(1).map(row => normalizeRow({
          "DATA COMPRA": row[0] || "",
          "VALORES A RECEBER": row[1] || "",
          "DESCRIÇÃO": row[2] || "",
          "LOJA": row[3] || "",
          "VALOR TOTAL": row[4] || "0",
          "CARTÃO": row[5] || "",
          "TOTAL PARCELAS": row[6] || 1,
          "PARCELA": row[7] || 1,
          "VALOR PARCELA": row[8] || "0",
          "DATA PAGTO": row[9] || "",
          "STATUS": row[10] || "Em aberto"
        }));
      }

      initTable();
      updateDashboard();
      updateAutoCompleteOptions();

      setSheetsStatus("Sheets: carregado", "ok");
    } catch (err) {
      console.error("Erro ao carregar planilha:", err);
      setSheetsStatus("Sheets: erro ao carregar", "err");
      alert("Erro ao carregar do Sheets. Veja o console (F12).");
    }
  }

  // Salva tudo: escreve cabeçalho + todas as linhas de uma vez.
  async function saveAllToSheets() {
    const ok = await ensureAccessToken();
    if (!ok) { alert("Não foi possível autenticar no Google."); return; }

    try {
      setSheetsStatus("Sheets: salvando…", "warn");

      // Monta matriz 2D (linhas x colunas) para o update
      const values = [
        HEADERS,
        ...tableData.map(r => ([
          r["DATA COMPRA"],
          r["VALORES A RECEBER"],
          r["DESCRIÇÃO"],
          r["LOJA"],
          r["VALOR TOTAL"],
          r["CARTÃO"],
          String(r["TOTAL PARCELAS"]),
          String(r["PARCELA"]),
          r["VALOR PARCELA"],
          r["DATA PAGTO"],
          r["STATUS"]
        ]))
      ];

      // 1) Limpa a área A:K inteira para não sobrar lixo de linhas antigas
      await gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId: SPREADSHEET_ID,
        range: DATA_RANGE_A1
      });

      // 2) Escreve tudo a partir do A1
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: WRITE_START_A1,
        valueInputOption: "USER_ENTERED",
        resource: { values }
      });

      setSheetsStatus("Sheets: salvo", "ok");
    } catch (err) {
      console.error("Erro ao salvar no Sheets:", err);
      setSheetsStatus("Sheets: erro ao salvar", "err");
      alert("Erro ao salvar no Sheets. Veja o console (F12).");
    }
  }

  $("#btnLoadSheets").on("click", loadFromSheets);
  $("#btnSaveSheets").on("click", saveAllToSheets);

  /**********************
   * Inicialização do app
   **********************/
  $(document).ready(function () {
    setSheetsStatus("Sheets: aguardando bibliotecas…", "warn");
    tableData = [];
    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    $("#chkAutoSave").prop("checked", false);
    document.getElementById("btnLoadSheets").disabled = true;
    document.getElementById("btnSaveSheets").disabled = true;
  });
</script>
</body>
</html>
