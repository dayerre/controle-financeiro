<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Controle Financeiro - Dayerre</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/date-eu.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 0;
      min-height: 100vh;
      font-size: 14px;
    }
    .navbar {
      background: linear-gradient(135deg, #007AFF, #005bb5);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 24px;
      border: none;
    }
    .summary-card {
      text-align: center;
      padding: 20px;
      border-radius: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .summary-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
    .summary-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .summary-value { font-size: 2rem; font-weight: 700; }

    .edit-cell { cursor: pointer; padding: 6px !important; font-size: 13px; }
    .edit-cell:hover { background: #f0f8ff !important; }
    #addRowForm { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 16px; display: none; }

    table.dataTable td { padding: 6px !important; font-size: 13px; }
    table.dataTable th { padding: 8px !important; font-size: 13px; text-align: center; }
    .dataTables_scrollBody { overflow-x: auto !important; }

    .money-cell { text-align: right; white-space: nowrap; font-weight: 500; }

    #monthlyReportModal .modal-dialog { max-width: 95%; }
    #monthlyReportTable td, #monthlyReportTable th { padding: 6px !important; font-size: 13px; }
    .month-input { width: 180px; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
    .toolbar .btn { margin: 0 !important; }
    .status-pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; }

    .limit-row-card { background:#f8f9fa; border-radius: 12px; padding: 12px; }
    .limit-table td, .limit-table th { font-size: 13px; padding: 8px !important; }
    .tag {
      display:inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px;
      background:#eef2ff; color:#2b3a67; margin-right: 6px; margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="navbar">Controle Financeiro - Dayerre</div>

  <div class="container pt-4">
    <div class="card">
      <h3 class="mb-4 text-center">Resumo Financeiro</h3>
      <div class="row text-center">
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-wallet2 summary-icon text-primary"></i>
            <div>Total Geral</div>
            <div class="summary-value text-primary" id="totalGeral">R$ 0,00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-check-circle summary-icon text-success"></i>
            <div>Total Pago</div>
            <div class="summary-value text-success" id="totalPago">R$ 0,00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card bg-light shadow-sm">
            <i class="bi bi-exclamation-triangle summary-icon text-danger"></i>
            <div>Total a Pagar</div>
            <div class="summary-value text-danger" id="totalAPagar">R$ 0,00</div>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-center mt-2" style="gap:10px;">
        <div>
          <span id="sheetsStatus" class="status-pill bg-light text-secondary">Sheets: aguardando…</span>
        </div>
        <div>
          <label class="mb-0" style="user-select:none;">
            <input type="checkbox" id="chkAutoSave" checked />
            Salvar automático no Sheets
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Lançamentos (Mais recente primeiro)</h3>

      <div class="toolbar">
        <button id="btnAddRow" class="btn btn-primary" type="button">+ Nova Parcela</button>
        <button id="btnExcluirRegistro" class="btn btn-danger" type="button">Excluir Registros</button>
        <button id="btnMarcarPago" class="btn btn-success" type="button">Marcar como Pago</button>
        <button id="btnUpdateTotals" class="btn btn-secondary" type="button">Atualizar Totais</button>
        <button id="btnMonthlyReport" class="btn btn-info" type="button">Relatórios Mensais</button>

        <button id="btnCardLimits" class="btn btn-outline-dark" type="button">
          <i class="bi bi-credit-card"></i> Limites de Cartão
        </button>

        <button id="btnLoadSheets" class="btn btn-warning" type="button" disabled>Carregar do Sheets</button>
        <button id="btnSaveSheets" class="btn btn-warning" type="button" disabled>Salvar no Sheets</button>

        <input type="file" id="fileInput" accept=".csv" style="display:none;" />
      </div>

      <div id="addRowForm" style="display:none;">
        <div class="card bg-light mb-4">
          <div class="card-body">
            <h5 class="card-title">Adicionar Nova Parcela</h5>
            <form id="newRowForm">
              <div class="form-row">
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newDataCompra" placeholder="DD/MM/AAAA" required />
                </div>
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newReceber" list="receberOptions" placeholder="Quem recebe" required />
                  <datalist id="receberOptions"></datalist>
                </div>
                <div class="col-md-4 mb-2">
                  <input type="text" class="form-control" id="newDescricao" placeholder="Descrição" required />
                </div>
                <div class="col-md-2 mb-2">
                  <input type="text" class="form-control" id="newLoja" list="lojaOptions" placeholder="Loja" />
                  <datalist id="lojaOptions"></datalist>
                </div>
              </div>

              <div class="form-row">
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newValorTotal" placeholder="R$ Valor Total" required />
                </div>
                <div class="col-md-3 mb-2">
                  <input type="text" class="form-control" id="newCartao" list="cartaoOptions" placeholder="Cartão (ex.: BTG, SICREDI, XP...)" required />
                  <datalist id="cartaoOptions"></datalist>
                </div>
                <div class="col-md-2 mb-2">
                  <input type="number" class="form-control" id="newTotalParcelas" min="1" value="1" placeholder="Total Parc." required />
                </div>
                <div class="col-md-2 mb-2">
                  <input type="text" class="form-control" id="newValorParcela" placeholder="R$ Parcela" readonly />
                </div>
                <div class="col-md-4 mb-2">
                  <input type="text" class="form-control" id="newDataPagamento" placeholder="DD/MM/AAAA" required />
                </div>
                <div class="col-md-3 mb-2">
                  <select class="form-control" id="newStatus" required>
                    <option value="Pago">Pago</option>
                    <option value="Em aberto" selected>Em aberto</option>
                  </select>
                </div>
                <div class="col-md-2 mb-2">
                  <button type="submit" class="btn btn-success btn-block">Adicionar</button>
                </div>
                <div class="col-md-2 mb-2">
                  <button type="button" id="cancelAdd" class="btn btn-secondary btn-block">Cancelar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <table id="dataTable" class="display compact" style="width:100%;">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>DATA COMPRA</th>
            <th>VALORES A RECEBER</th>
            <th>DESCRIÇÃO</th>
            <th>LOJA</th>
            <th>VALOR TOTAL</th>
            <th>CARTÃO</th>
            <th>TOTAL PARCELAS</th>
            <th>PARCELA</th>
            <th>VALOR PARCELA</th>
            <th>DATA PAGTO</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Limites de Cartão -->
  <div class="modal fade" id="cardLimitsModal" tabindex="-1" role="dialog" aria-labelledby="cardLimitsLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cardLimitsLabel">Limites de Cartão</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true"></span>
          </button>
        </div>

        <div class="modal-body">
          <div class="limit-row-card mb-3">
            <div class="form-row">
              <div class="col-md-4 mb-2">
                <label>Escolher (dos lançamentos)</label>
                <select class="form-control" id="limitLaunchCard">
                  <option value="">(Selecionar...)</option>
                </select>
                <small class="text-muted">Escolha um texto que aparece no campo CARTÃO dos lançamentos (ex.: BTG).</small>
              </div>

              <div class="col-md-4 mb-2">
                <label>Banco</label>
                <input type="text" class="form-control" id="limitBank" placeholder="Ex.: BTG Pactual" />
              </div>

              <div class="col-md-4 mb-2">
                <label>Bandeira</label>
                <input type="text" class="form-control" id="limitBrand" placeholder="Ex.: Mastercard" />
              </div>
            </div>

            <div class="form-row">
              <div class="col-md-4 mb-2">
                <label>Categoria</label>
                <input type="text" class="form-control" id="limitCategory" placeholder="Ex.: BLACK, GOLD, PLATINIUM" />
              </div>

              <div class="col-md-4 mb-2">
                <label>Limite total</label>
                <input type="text" class="form-control" id="limitTotal" placeholder="Ex.: 4500" />
              </div>

              <div class="col-md-4 mb-2 d-flex align-items-end">
                <div class="w-100">
                  <button class="btn btn-dark btn-block" id="btnSaveLimit" type="button">Salvar / Atualizar</button>
                  <button class="btn btn-outline-secondary btn-block mt-2" id="btnClearLimit" type="button">Limpar</button>
                </div>
              </div>
            </div>

            <div class="form-row mt-2">
              <div class="col-md-12">
                <label>Textos do campo CARTÃO que pertencem a este cartão (aliases)</label>
                <input type="text" class="form-control" id="limitAliases" placeholder="Ex.: BTG; BTG PACTUAL (separar por ; )" />
                <small class="text-muted">O sistema soma “Em aberto” considerando todos esses textos como o mesmo cartão.</small>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-2" style="gap:10px;">
            <div class="text-muted">
              Você pode “Ocultar” itens como <strong>Débito</strong> e <strong>Depósito</strong> para não aparecerem aqui, sem alterar lançamentos.
            </div>
            <div>
              <button class="btn btn-outline-secondary btn-sm" id="btnShowHidden" type="button">Mostrar ocultos</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-striped limit-table">
              <thead>
                <tr>
                  <th>Cartão</th>
                  <th class="text-right">Limite total</th>
                  <th class="text-right">Em aberto</th>
                  <th class="text-right">Limite livre</th>
                  <th class="text-center">Ações</th>
                </tr>
              </thead>
              <tbody id="limitsTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Relatórios Mensais -->
  <div class="modal fade" id="monthlyReportModal" tabindex="-1" role="dialog" aria-labelledby="monthlyReportLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="monthlyReportLabel">Relatórios Mensais Financeiros</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true"></span>
          </button>
        </div>

        <div class="modal-body">
          <div class="row no-print">
            <div class="col-md-4 mb-3">
              <label for="monthInput">Mês/Ano</label>
              <input type="month" id="monthInput" class="form-control month-input" />
            </div>
            <div class="col-md-4 mb-3">
              <label for="recipientSelect">Quem Recebe</label>
              <select id="recipientSelect" class="form-control">
                <option value="Todos">Todos</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="cardSelect">Cartão</label>
              <select id="cardSelect" class="form-control">
                <option value="Todos">Todos</option>
              </select>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-body">
              <h5>Resumo do Período Filtrado</h5>
              <div class="row text-center">
                <div class="col-md-4">Total Geral <strong id="reportTotalGeral">R$ 0,00</strong></div>
                <div class="col-md-4">Total Pago <strong id="reportTotalPago">R$ 0,00</strong></div>
                <div class="col-md-4">Total a Pagar <strong id="reportTotalAPagar">R$ 0,00</strong></div>
              </div>
            </div>
          </div>

          <table id="monthlyReportTable" class="display compact mt-4" style="width:100%;">
            <thead>
              <tr>
                <th>DATA COMPRA</th>
                <th>VALORES A RECEBER</th>
                <th>DESCRIÇÃO</th>
                <th>LOJA</th>
                <th>VALOR TOTAL</th>
                <th>CARTÃO</th>
                <th>PARCELA TOTAL</th>
                <th>VALOR PARCELA</th>
                <th>DATA PAGTO</th>
                <th>STATUS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" id="btnPrintReport">Imprimir</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const CLIENT_ID = "749047478128-8mh27i6lmrbljkn0b7i2u9p8q28i8t63.apps.googleusercontent.com";
  const SPREADSHEET_ID = "1CMaWjOpN45pjtMYAs9hfn0ovFvhXPaiZNbwDnzNSuZA";
  const SHEET_NAME = "Sheet1";
  const DISCOVERY_DOC = "https://sheets.googleapis.com/$discovery/rest?version=v4";

  const HEADERS = ["DATA COMPRA","VALORES A RECEBER","DESCRIÇÃO","LOJA","VALOR TOTAL","CARTÃO","TOTAL PARCELAS","PARCELA","VALOR PARCELA","DATA PAGTO","STATUS"];
  const DATA_RANGE_A1 = `${SHEET_NAME}!A:K`;
  const WRITE_START_A1 = `${SHEET_NAME}!A1`;

  // NOVO modelo:
  // cardLimits = [{ id, bank, brand, category, total, aliases:[], hidden:false }]
  const LS_LIMITS_KEY = "cf_dayerre_card_limits_v3";
  let cardLimits = [];
  let showHidden = false;

  let tokenClient = null;
  let gapiInited = false;
  let gisInited = false;
  let hasToken = false;

  let tableData = [];
  let dataTable = null;
  let monthlyReportTable = null;

  function formatMoneyBR(num) {
    if (isNaN(num) || num === null) return "R$ 0,00";
    return "R$ " + Number(num).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function parseMoneyBR(str) {
    if (str === null || str === undefined) return 0;
    const cleaned = String(str).replace(/\s/g, "").replace(/^R\$/i, "").replace(/[^0-9,.\-]/g, "");
    if (!cleaned) return 0;
    if (cleaned.includes(",")) return parseFloat(cleaned.replace(/\./g, "").replace(",", ".")) || 0;
    return parseFloat(cleaned) || 0;
  }
  function parseDateBR(s) {
    if (!s) return null;
    const [d, m, y] = String(s).split("/");
    return (y && m && d) ? new Date(y, m - 1, d) : null;
  }
  function formatDateBR(date) {
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    return `${d}/${m}/${date.getFullYear()}`;
  }
  function addMonthsToDateBR(s, months) {
    const d = parseDateBR(s);
    if (!d) return s;
    d.setMonth(d.getMonth() + months);
    return formatDateBR(d);
  }

  function setSheetsStatus(text, kind) {
    const el = document.getElementById("sheetsStatus");
    el.textContent = text;
    el.classList.remove("bg-light","bg-success","bg-warning","bg-danger","text-secondary","text-dark","text-white");
    if (kind === "ok") el.classList.add("bg-success","text-white");
    else if (kind === "warn") el.classList.add("bg-warning","text-dark");
    else if (kind === "err") el.classList.add("bg-danger","text-white");
    else el.classList.add("bg-light","text-secondary");
  }

  function normalizeRow(r) {
    return {
      "DATA COMPRA": (r["DATA COMPRA"] || "").trim(),
      "VALORES A RECEBER": (r["VALORES A RECEBER"] || "").trim(),
      "DESCRIÇÃO": (r["DESCRIÇÃO"] || "").trim(),
      "LOJA": (r["LOJA"] || "").trim(),
      "VALOR TOTAL": formatMoneyBR(parseMoneyBR(r["VALOR TOTAL"] || "0")),
      "CARTÃO": (r["CARTÃO"] || "").trim(),
      "TOTAL PARCELAS": parseInt(r["TOTAL PARCELAS"]) || 1,
      "PARCELA": parseInt(r["PARCELA"]) || 1,
      "VALOR PARCELA": formatMoneyBR(parseMoneyBR(r["VALOR PARCELA"] || "0")),
      "DATA PAGTO": (r["DATA PAGTO"] || "").trim(),
      "STATUS": (r["STATUS"] || "Em aberto").trim() || "Em aberto"
    };
  }

  function updateAutoCompleteOptions() {
    const receberSet = new Set(tableData.map(r => r["VALORES A RECEBER"]).filter(Boolean));
    const cartaoSet  = new Set(tableData.map(r => r["CARTÃO"]).filter(Boolean));
    const lojaSet    = new Set(tableData.map(r => r["LOJA"]).filter(Boolean));

    $("#receberOptions").html(Array.from(receberSet).sort().map(v => `<option value="${v}"></option>`).join(""));
    $("#lojaOptions").html(Array.from(lojaSet).sort().map(v => `<option value="${v}"></option>`).join(""));

    // Sugestões: cartões dos lançamentos + aliases cadastrados
    const aliasSet = new Set((cardLimits || []).flatMap(c => (c.aliases || [])).filter(Boolean));
    const merged = new Set([...cartaoSet, ...aliasSet]);
    $("#cartaoOptions").html(Array.from(merged).sort().map(v => `<option value="${v}"></option>`).join(""));
  }

  function updateDashboard() {
    let totalG = 0, pago = 0, apagar = 0;
    tableData.forEach(r => {
      const v = parseMoneyBR(r["VALOR PARCELA"]);
      totalG += v;
      if ((r["STATUS"] || "").trim() === "Pago") pago += v;
      else apagar += v;
    });
    $("#totalGeral").text(formatMoneyBR(totalG));
    $("#totalPago").text(formatMoneyBR(pago));
    $("#totalAPagar").text(formatMoneyBR(apagar));

    if ($("#cardLimitsModal").hasClass("show")) renderCardLimitsTable();
  }

  function initTable() {
    if (dataTable) dataTable.destroy();

    dataTable = $("#dataTable").DataTable({
      data: tableData,
      columns: [
        { data: null, orderable: false, render: () => '<input type="checkbox" class="row-checkbox" />' },
        { data: "DATA COMPRA", type: "date-eu", className: "edit-cell" },
        { data: "VALORES A RECEBER", className: "edit-cell" },
        { data: "DESCRIÇÃO", className: "edit-cell" },
        { data: "LOJA", className: "edit-cell" },
        { data: "VALOR TOTAL", render: d => formatMoneyBR(parseMoneyBR(d)), className: "edit-cell money-cell" },
        { data: "CARTÃO", className: "edit-cell" },
        { data: "TOTAL PARCELAS", className: "edit-cell text-center" },
        { data: "PARCELA", className: "edit-cell text-center" },
        { data: "VALOR PARCELA", render: d => formatMoneyBR(parseMoneyBR(d)), className: "edit-cell money-cell" },
        { data: "DATA PAGTO", className: "edit-cell" },
        { data: "STATUS", className: "edit-cell" }
      ],
      order: [[1, "desc"]],
      pageLength: 20,
      lengthMenu: [20, 40, 60, 80, 100, 200, -1],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
      scrollX: true
    });

    $("#dataTable tbody").off("click").on("click", "td.edit-cell", function () {
      const cell = dataTable.cell(this);
      const field = dataTable.column(cell.index().column).header().textContent.trim();
      const oldVal = cell.data();

      const input = $(`<input type="text" class="form-control form-control-sm" value="${oldVal ?? ""}">`);
      $(this).html(input);
      input.focus().select();

      input.on("blur", async function () {
        let newVal = input.val().trim();

        if (field.includes("VALOR")) newVal = formatMoneyBR(parseMoneyBR(newVal));
        else if (field.includes("TOTAL PARCELAS") || field === "PARCELA") newVal = parseInt(newVal) || 0;

        cell.data(newVal);
        dataTable.draw(false);

        const rowIdx = cell.index().row;
        tableData[rowIdx][field] = newVal;
        tableData[rowIdx] = normalizeRow(tableData[rowIdx]);

        updateDashboard();
        updateAutoCompleteOptions();

        if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
      });

      input.on("keypress", function (e) { if (e.which === 13) input.blur(); });
    });

    $("#selectAll").off("change").on("change", function () {
      $(".row-checkbox").prop("checked", this.checked);
    });
  }

  // ---- Limites v3
  function loadCardLimits() {
    try {
      const raw = localStorage.getItem(LS_LIMITS_KEY);
      cardLimits = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(cardLimits)) cardLimits = [];
    } catch (e) {
      cardLimits = [];
    }
  }
  function saveCardLimits() {
    localStorage.setItem(LS_LIMITS_KEY, JSON.stringify(cardLimits || []));
  }

  function getUniqueLaunchCards() {
    return Array.from(new Set(tableData.map(r => (r["CARTÃO"] || "").trim()).filter(Boolean)))
      .sort((a,b) => a.localeCompare(b, "pt-BR", {sensitivity:"base"}));
  }

  function parseAliases(s) {
    return Array.from(new Set(
      String(s || "")
        .split(";")
        .map(x => x.trim())
        .filter(Boolean)
    ));
  }

  // soma em aberto por texto exato do CARTÃO
  function sumOpenByLaunchCardText() {
    return tableData.reduce((acc, r) => {
      const card = (r["CARTÃO"] || "").trim();
      if (!card) return acc;
      const st = (r["STATUS"] || "").trim();
      if (st === "Pago") return acc;
      const v = parseMoneyBR(r["VALOR PARCELA"]);
      acc[card] = (acc[card] || 0) + v;
      return acc;
    }, {});
  }

  // soma em aberto do cartão cadastrado (considerando aliases)
  function sumOpenForLimitItem(item, openMap) {
    const aliases = (item.aliases || []).map(x => String(x).trim()).filter(Boolean);
    if (aliases.length === 0) return 0;
    return aliases.reduce((sum, a) => sum + (openMap[a] || 0), 0);
  }

  function clearLimitForm() {
    $("#limitLaunchCard").val("");
    $("#limitBank").val("");
    $("#limitBrand").val("");
    $("#limitCategory").val("");
    $("#limitTotal").val("");
    $("#limitAliases").val("");
    $("#btnSaveLimit").data("editId", "");
  }

  function fillLaunchCardSelect() {
    const sel = $("#limitLaunchCard");
    const current = sel.val() || "";
    sel.empty().append(`<option value="">(Selecionar...)</option>`);
    getUniqueLaunchCards().forEach(c => sel.append(`<option value="${c}">${c}</option>`));
    sel.val(current);
  }

  // cria itens “não cadastrados” para poder ocultar/remover da lista
  function ensurePlaceholderItemsForLaunchCards() {
    const launchCards = getUniqueLaunchCards();
    launchCards.forEach(txt => {
      const exists = cardLimits.some(it => (it.aliases || []).includes(txt));
      // Não cria placeholder se já existe em algum alias cadastrado
      if (!exists) {
        // placeholder fica sem total, mas permite ocultar
        // só cria se ainda não existir placeholder com aliases=[txt]
        const already = cardLimits.some(it => (it.total === null || it.total === undefined) && (it.aliases || []).length === 1 && it.aliases[0] === txt);
        if (!already) {
          cardLimits.push({
            id: "ph_" + txt,
            bank: "",
            brand: "",
            category: "",
            total: null,
            aliases: [txt],
            hidden: false,
            placeholder: true
          });
        }
      }
    });
  }

  function renderCardLimitsTable() {
    fillLaunchCardSelect();

    // cria placeholders para permitir ocultar "Débito/Depósito" etc
    ensurePlaceholderItemsForLaunchCards();
    // salva depois de garantir placeholders
    saveCardLimits();

    const openMap = sumOpenByLaunchCardText();
    const tbody = $("#limitsTbody");
    tbody.empty();

    const items = [...cardLimits]
      .filter(it => showHidden ? true : !it.hidden)
      .sort((a,b) => {
        const aName = (a.aliases && a.aliases[0]) ? a.aliases[0] : "";
        const bName = (b.aliases && b.aliases[0]) ? b.aliases[0] : "";
        return aName.localeCompare(bName, "pt-BR", { sensitivity: "base" });
      });

    if (items.length === 0) {
      tbody.append(`<tr><td colspan="5" class="text-center text-muted">Nenhum item.</td></tr>`);
      return;
    }

    items.forEach(item => {
      const displayName = (item.aliases && item.aliases[0]) ? item.aliases[0] : "(sem nome)";
      const open = sumOpenForLimitItem(item, openMap);

      const total = (item.total === null || item.total === undefined) ? null : (Number(item.total) || 0);
      const free = (total === null) ? null : (total - open);

      const hasLimit = total !== null;

      const freeClass =
        !hasLimit ? "text-muted" :
        free < 0 ? "text-danger" :
        free < total * 0.15 ? "text-warning" :
        "text-success";

      const categoryTag = item.category ? `<span class="tag">${String(item.category).toUpperCase()}</span>` : "";
      const hiddenTag = item.hidden ? `<span class="badge badge-secondary ml-2">Oculto</span>` : "";
      const noLimitTag = !hasLimit ? `<span class="badge badge-warning ml-2">Sem limite cadastrado</span>` : "";

      const aliasesHtml = (item.aliases || []).slice(0, 6).map(a => `<span class="tag">${a}</span>`).join("");

      tbody.append(`
        <tr>
          <td>
            <div><strong>${displayName}</strong>${hiddenTag}${noLimitTag}</div>
            <div class="mt-1">${categoryTag}${aliasesHtml}</div>
            <small class="text-muted">
              Banco: ${item.bank || "-"} | Bandeira: ${item.brand || "-"}
            </small>
          </td>
          <td class="text-right">${hasLimit ? formatMoneyBR(total) : "-"}</td>
          <td class="text-right">${formatMoneyBR(open)}</td>
          <td class="text-right ${freeClass}">${hasLimit ? `<strong>${formatMoneyBR(free)}</strong>` : "-"}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary btnEditLimit" type="button" data-id="${item.id}">Editar</button>
            <button class="btn btn-sm btn-outline-danger btnDeleteLimit" type="button" data-id="${item.id}" ${item.placeholder ? "disabled" : ""}>Excluir</button>
            <button class="btn btn-sm btn-outline-secondary btnToggleHidden" type="button" data-id="${item.id}">
              ${item.hidden ? "Reexibir" : "Ocultar"}
            </button>
          </td>
        </tr>
      `);
    });
  }

  function setFormFromItem(item) {
    $("#limitBank").val(item.bank || "");
    $("#limitBrand").val(item.brand || "");
    $("#limitCategory").val(item.category || "");
    $("#limitTotal").val(item.total === null || item.total === undefined ? "" : String(item.total));
    $("#limitAliases").val((item.aliases || []).join("; "));
    $("#btnSaveLimit").data("editId", item.id);
  }

  function upsertLimit() {
    const editId = $("#btnSaveLimit").data("editId") || "";
    const bank = $("#limitBank").val().trim();
    const brand = $("#limitBrand").val().trim();
    const category = $("#limitCategory").val().trim();
    const totalRaw = $("#limitTotal").val().trim();
    const total = totalRaw ? parseMoneyBR(totalRaw) : null;
    const aliases = parseAliases($("#limitAliases").val());

    if (aliases.length === 0) { alert("Informe pelo menos 1 alias (texto do campo CARTÃO)."); return; }
    if (total !== null && !(total > 0)) { alert("Limite total inválido (ou deixe em branco)."); return; }

    // Regra: alias não pode pertencer a 2 cartões cadastrados (com limite)
    // (para não duplicar soma)
    const aliasConflicts = [];
    aliases.forEach(a => {
      cardLimits.forEach(it => {
        if (it.id === editId) return;
        const itAliases = it.aliases || [];
        const itHasLimit = !(it.total === null || it.total === undefined);
        if (itHasLimit && itAliases.includes(a)) aliasConflicts.push({ alias:a, other:(itAliases[0]||it.id) });
      });
    });
    if (aliasConflicts.length > 0) {
      alert("Esse alias já está sendo usado por outro cartão com limite: " + aliasConflicts[0].alias);
      return;
    }

    if (editId) {
      const idx = cardLimits.findIndex(x => x.id === editId);
      if (idx >= 0) {
        cardLimits[idx] = {
          ...cardLimits[idx],
          bank, brand, category,
          total,
          aliases,
          placeholder: false,
          hidden: false
        };
      }
    } else {
      cardLimits.push({
        id: String(Date.now()),
        bank, brand, category,
        total,
        aliases,
        hidden: false,
        placeholder: false
      });
    }

    // remove placeholders duplicados que tenham o mesmo alias[0] sozinho
    const usedAliasSingles = new Set(cardLimits.filter(x => !x.placeholder).flatMap(x => x.aliases || []));
    cardLimits = cardLimits.filter(x => {
      if (!x.placeholder) return true;
      const a0 = (x.aliases || [])[0];
      if (!a0) return false;
      return !usedAliasSingles.has(a0);
    });

    saveCardLimits();
    updateAutoCompleteOptions();
    renderCardLimitsTable();
    clearLimitForm();
  }

  function deleteLimit(id) {
    const item = cardLimits.find(x => x.id === id);
    if (!item) return;
    if (!confirm(`Excluir este cadastro de limite? (Não altera lançamentos)`)) return;
    // excluir só itens não-placeholder
    cardLimits = cardLimits.filter(x => x.id !== id);
    saveCardLimits();
    updateAutoCompleteOptions();
    renderCardLimitsTable();
    clearLimitForm();
  }

  function toggleHidden(id) {
    const idx = cardLimits.findIndex(x => x.id === id);
    if (idx < 0) return;
    cardLimits[idx].hidden = !cardLimits[idx].hidden;
    saveCardLimits();
    renderCardLimitsTable();
  }

  // eventos do modal
  $("#btnCardLimits").on("click", function () {
    renderCardLimitsTable();
    $("#cardLimitsModal").modal("show");
  });

  $("#btnShowHidden").on("click", function () {
    showHidden = !showHidden;
    $(this).text(showHidden ? "Ocultar ocultos" : "Mostrar ocultos");
    renderCardLimitsTable();
  });

  $("#btnClearLimit").on("click", clearLimitForm);
  $("#btnSaveLimit").on("click", upsertLimit);

  $("#limitLaunchCard").on("change", function () {
    const txt = ($(this).val() || "").trim();
    if (!txt) return;
    // facilita: joga o escolhido no aliases
    const current = parseAliases($("#limitAliases").val());
    if (!current.includes(txt)) current.unshift(txt);
    $("#limitAliases").val(current.join("; "));
  });

  $("#limitsTbody").on("click", ".btnEditLimit", function () {
    const id = $(this).data("id");
    const item = cardLimits.find(x => x.id === id);
    if (!item) return;
    setFormFromItem(item);
  });

  $("#limitsTbody").on("click", ".btnDeleteLimit", function () {
    const id = $(this).data("id");
    deleteLimit(id);
  });

  $("#limitsTbody").on("click", ".btnToggleHidden", function () {
    const id = $(this).data("id");
    toggleHidden(id);
  });

  // ---- Lançamentos (restante igual ao seu)
  $("#btnAddRow").on("click", function () {
    $("#addRowForm").slideToggle(300);
    updateAutoCompleteOptions();
    const hoje = formatDateBR(new Date());
    $("#newDataCompra").val(hoje);
    $("#newDataPagamento").val(hoje);
  });

  $("#cancelAdd").on("click", function () {
    $("#addRowForm").slideUp(300);
    $("#newRowForm")[0].reset();
  });

  $("#newDataCompra, #newDataPagamento").on("input", function () {
    let v = this.value.replace(/\D/g, "").slice(0, 8);
    if (v.length > 2) v = v.slice(0,2) + "/" + v.slice(2);
    if (v.length > 5) v = v.slice(0,5) + "/" + v.slice(5);
    this.value = v;
  });

  $("#newValorTotal").on("input", function () { this.value = this.value.replace(/[^0-9,.\-]/g, ""); });
  $("#newValorTotal, #newTotalParcelas").on("input change", function () {
    const total = parseMoneyBR($("#newValorTotal").val());
    const parc = parseInt($("#newTotalParcelas").val()) || 1;
    $("#newValorParcela").val(formatMoneyBR(total / parc));
  });

  $("#newRowForm").on("submit", async function (e) {
    e.preventDefault();

    const dataCompra = $("#newDataCompra").val().trim();
    const dataPrimeira = $("#newDataPagamento").val().trim();

    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dataCompra)) { alert("Data da compra inválida! Use DD/MM/AAAA"); return; }
    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dataPrimeira)) { alert("Data da primeira parcela inválida! Use DD/MM/AAAA"); return; }

    const base = normalizeRow({
      "DATA COMPRA": dataCompra,
      "VALORES A RECEBER": $("#newReceber").val().trim(),
      "DESCRIÇÃO": $("#newDescricao").val().trim(),
      "LOJA": $("#newLoja").val().trim(),
      "VALOR TOTAL": $("#newValorTotal").val(),
      "CARTÃO": $("#newCartao").val().trim(),
      "TOTAL PARCELAS": parseInt($("#newTotalParcelas").val()) || 1,
      "PARCELA": 1,
      "VALOR PARCELA": $("#newValorParcela").val(),
      "DATA PAGTO": dataPrimeira,
      "STATUS": $("#newStatus").val()
    });

    const totalParcelas = base["TOTAL PARCELAS"];
    for (let i = 1; i <= totalParcelas; i++) {
      const r = { ...base, "PARCELA": i, "DATA PAGTO": addMonthsToDateBR(dataPrimeira, i - 1) };
      tableData.push(normalizeRow(r));
    }

    tableData.sort((a, b) => (parseDateBR(b["DATA COMPRA"]) - parseDateBR(a["DATA COMPRA"])));

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    this.reset();
    $("#addRowForm").slideUp(300);

    if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
    else alert("Parcelas adicionadas. Clique em “Salvar no Sheets” para gravar.");
  });

  $("#btnExcluirRegistro").on("click", async function () {
    const selecionados = $(".row-checkbox:checked").length;
    if (selecionados === 0) { alert("Selecione pelo menos um registro para excluir."); return; }
    if (!confirm(`Tem certeza que deseja excluir ${selecionados} registros?`)) return;

    const indices = [];
    $(".row-checkbox:checked").each(function () {
      const row = $(this).closest("tr");
      const idx = dataTable.row(row).index();
      indices.push(idx);
    });

    indices.sort((a,b) => b-a).forEach(idx => tableData.splice(idx, 1));

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
  });

  $("#btnMarcarPago").on("click", async function () {
    const selecionados = $(".row-checkbox:checked").length;
    if (selecionados === 0) { alert("Selecione pelo menos um registro para marcar como pago."); return; }
    if (!confirm(`Tem certeza que deseja marcar ${selecionados} registros como PAGO?`)) return;

    $(".row-checkbox:checked").each(function () {
      const row = $(this).closest("tr");
      const idx = dataTable.row(row).index();
      if (tableData[idx]) tableData[idx]["STATUS"] = "Pago";
      tableData[idx] = normalizeRow(tableData[idx]);
    });

    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    if ($("#chkAutoSave").prop("checked")) await saveAllToSheets();
  });

  $("#btnUpdateTotals").on("click", function () {
    initTable();
    updateDashboard();
    updateAutoCompleteOptions();
    alert("Totais atualizados com sucesso!");
  });

  function updateReport() {
    const monthValue = $("#monthInput").val();
    const recipient = $("#recipientSelect").val();
    const card = $("#cardSelect").val();

    const filtered = tableData.filter(row => {
      const datePagto = parseDateBR(row["DATA PAGTO"]);
      if (!datePagto) return false;

      if (monthValue) {
        const [y, m] = monthValue.split("-").map(Number);
        if (datePagto.getFullYear() !== y) return false;
        if ((datePagto.getMonth() + 1) !== m) return false;
      }
      if (recipient && recipient !== "Todos" && row["VALORES A RECEBER"] !== recipient) return false;
      if (card && card !== "Todos" && row["CARTÃO"] !== card) return false;

      return true;
    });

    let total = 0, pago = 0, apagar = 0;
    filtered.forEach(r => {
      const v = parseMoneyBR(r["VALOR PARCELA"]);
      total += v;
      if ((r["STATUS"] || "").trim() === "Pago") pago += v;
      else apagar += v;
    });

    $("#reportTotalGeral").text(formatMoneyBR(total));
    $("#reportTotalPago").text(formatMoneyBR(pago));
    $("#reportTotalAPagar").text(formatMoneyBR(apagar));

    if (monthlyReportTable) monthlyReportTable.destroy();

    monthlyReportTable = $("#monthlyReportTable").DataTable({
      data: filtered,
      columns: [
        { data: "DATA COMPRA" },
        { data: "VALORES A RECEBER" },
        { data: "DESCRIÇÃO" },
        { data: "LOJA" },
        { data: "VALOR TOTAL", render: d => formatMoneyBR(parseMoneyBR(d)) },
        { data: "CARTÃO" },
        { data: null, render: d => `${d["PARCELA"]}/${d["TOTAL PARCELAS"]}`, className: "text-center" },
        { data: "VALOR PARCELA", render: d => formatMoneyBR(parseMoneyBR(d)) },
        { data: "DATA PAGTO" },
        { data: "STATUS" }
      ],
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100, -1],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
      dom: "frtip",
      order: [[8, "asc"]]
    });
  }

  $("#btnMonthlyReport").on("click", function () {
    const recipientSet = new Set(tableData.map(r => r["VALORES A RECEBER"]).filter(Boolean));
    const cardSet = new Set(tableData.map(r => r["CARTÃO"]).filter(Boolean));

    const selRec = $("#recipientSelect");
    selRec.empty().append(`<option value="Todos">Todos</option>`);
    Array.from(recipientSet).sort().forEach(v => selRec.append(`<option value="${v}">${v}</option>`));

    const selCard = $("#cardSelect");
    selCard.empty().append(`<option value="Todos">Todos</option>`);
    Array.from(cardSet).sort().forEach(v => selCard.append(`<option value="${v}">${v}</option>`));

    if (monthlyReportTable) monthlyReportTable.destroy();
    updateReport();
    $("#monthlyReportModal").modal("show");
  });

  $("#monthInput, #recipientSelect, #cardSelect").on("change", updateReport);

  $("#btnPrintReport").on("click", function () {
    if (!monthlyReportTable) { window.print(); return; }
    const oldLen = monthlyReportTable.page.len();
    monthlyReportTable.page.len(-1).draw();

    setTimeout(() => {
      try { monthlyReportTable.columns.adjust().draw(false); } catch(e) {}
      window.print();
      setTimeout(() => monthlyReportTable.page.len(oldLen).draw(), 300);
    }, 200);
  });

  function maybeEnableSheetsButtons() {
    if (gapiInited && gisInited) {
      document.getElementById("btnLoadSheets").disabled = false;
      document.getElementById("btnSaveSheets").disabled = false;
      setSheetsStatus("Sheets: pronto (faça login para carregar/salvar)", "warn");
    }
  }

  window.gapiLoaded = function () {
    gapi.load("client", async () => {
      try {
        await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
        maybeEnableSheetsButtons();
      } catch (e) {
        console.error("Falha ao inicializar gapi.client:", e);
        setSheetsStatus("Sheets: erro ao iniciar gapi", "err");
        alert("Falha ao inicializar Google API (gapi). Veja o console (F12).");
      }
    });
  };

  window.gisLoaded = function () {
    try {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets",
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.error) {
            console.error("Erro OAuth:", tokenResponse);
            setSheetsStatus("Sheets: erro no login", "err");
            alert("Erro na autorização: " + tokenResponse.error);
            return;
          }
          hasToken = true;
          setSheetsStatus("Sheets: autenticado", "ok");
        }
      });
      gisInited = true;
      maybeEnableSheetsButtons();
    } catch (e) {
      console.error("Falha ao inicializar GIS tokenClient:", e);
      setSheetsStatus("Sheets: erro ao iniciar login", "err");
      alert("Falha ao inicializar Google Identity Services. Veja o console (F12).");
    }
  };

  async function ensureAccessToken() {
    if (hasToken) return true;
    if (!tokenClient) return false;

    return new Promise((resolve) => {
      tokenClient.callback = (tokenResponse) => {
        if (tokenResponse && tokenResponse.error) {
          console.error("Erro OAuth:", tokenResponse);
          setSheetsStatus("Sheets: erro no login", "err");
          resolve(false);
          return;
        }
        hasToken = true;
        setSheetsStatus("Sheets: autenticado", "ok");
        resolve(true);
      };
      tokenClient.requestAccessToken({ prompt: "" });
    });
  }

  async function loadFromSheets() {
    const ok = await ensureAccessToken();
    if (!ok) { alert("Não foi possível autenticar no Google."); return; }

    try {
      setSheetsStatus("Sheets: carregando…", "warn");
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: DATA_RANGE_A1
      });
      const rows = response.result.values || [];

      if (rows.length <= 1) tableData = [];
      else {
        tableData = rows.slice(1).map(row => normalizeRow({
          "DATA COMPRA": row[0] || "",
          "VALORES A RECEBER": row[1] || "",
          "DESCRIÇÃO": row[2] || "",
          "LOJA": row[3] || "",
          "VALOR TOTAL": row[4] || "0",
          "CARTÃO": row[5] || "",
          "TOTAL PARCELAS": row[6] || 1,
          "PARCELA": row[7] || 1,
          "VALOR PARCELA": row[8] || "0",
          "DATA PAGTO": row[9] || "",
          "STATUS": row[10] || "Em aberto"
        }));
      }

      initTable();
      updateDashboard();
      updateAutoCompleteOptions();

      setSheetsStatus("Sheets: carregado", "ok");
    } catch (err) {
      console.error("Erro ao carregar planilha:", err);
      setSheetsStatus("Sheets: erro ao carregar", "err");
      alert("Erro ao carregar do Sheets. Veja o console (F12).");
    }
  }

  async function saveAllToSheets() {
    const ok = await ensureAccessToken();
    if (!ok) { alert("Não foi possível autenticar no Google."); return; }

    try {
      setSheetsStatus("Sheets: salvando…", "warn");

      const values = [
        HEADERS,
        ...tableData.map(r => ([
          r["DATA COMPRA"],
          r["VALORES A RECEBER"],
          r["DESCRIÇÃO"],
          r["LOJA"],
          r["VALOR TOTAL"],
          r["CARTÃO"],
          String(r["TOTAL PARCELAS"]),
          String(r["PARCELA"]),
          r["VALOR PARCELA"],
          r["DATA PAGTO"],
          r["STATUS"]
        ]))
      ];

      await gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId: SPREADSHEET_ID,
        range: DATA_RANGE_A1
      });

      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: WRITE_START_A1,
        valueInputOption: "USER_ENTERED",
        resource: { values }
      });

      setSheetsStatus("Sheets: salvo", "ok");
    } catch (err) {
      console.error("Erro ao salvar no Sheets:", err);
      setSheetsStatus("Sheets: erro ao salvar", "err");
      alert("Erro ao salvar no Sheets. Veja o console (F12).");
    }
  }

  $("#btnLoadSheets").on("click", loadFromSheets);
  $("#btnSaveSheets").on("click", saveAllToSheets);

  $(document).ready(function () {
    setSheetsStatus("Sheets: aguardando bibliotecas…", "warn");

    loadCardLimits();
    clearLimitForm();

    tableData = [];
    initTable();
    updateDashboard();
    updateAutoCompleteOptions();

    $("#chkAutoSave").prop("checked", true);
    document.getElementById("btnLoadSheets").disabled = true;
    document.getElementById("btnSaveSheets").disabled = true;
  });
</script>
</body>
</html>
